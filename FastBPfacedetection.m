function FastBPfacedetection()
%% ????????
global imgRow;
global imgCol;
global net

display(' ');
display(' ');
display('train begining...');

nPerson=40;
nFacesPerPerson = 5;
display('read face images...');
[imgRow,imgCol,FaceContainer,faceLabel]=ReadFaces(nFacesPerPerson,nPerson);
nFaces=size(FaceContainer,1);%?????????40*5=200????

display('PCA down...');
k=49;   %? k ?????????
[pcaFaces, W] = fastPCA(FaceContainer, k); % ?????PCA
% pcaFaces?200*49???, ???????????(?40????5?)????49???
% W???????, 10304*49 ???
%visualize_pc(W);%??????


X = pcaFaces;

display('normalization begining...');
display('.........');

[X,A0,B0] = scaling(X);
save('Mat/scaling.mat', 'A0', 'B0');
% ?? scaling ??????? trainData.mat
TrainData = X;
trainLabel = faceLabel;   %?ReadFaces.m???????????200*1??????
save('Mat/trainData.mat', 'TrainData', 'trainLabel');
display('normalization finish...');

%% ?????????BP????

%????BP??????? P 
%200*49???, ???????????(?40????5?)????49???????
%?faceLabel?200*1???????
P=TrainData;
%???????? T
T=zeros(200,40);
 for i=1:40
    for j=1:5
      T((i-1)*5+j,i)=1;
    end
 end
 
%????????
%P(200*49)   T(200*40)????
gx2(:,1:k)=P;  %? k ????????? k=49
gx2(:,(k+1):(k+40))=T;
xd=gx2(randperm(numel(gx2)/(k+40)),:);   %matlab  randperm???????????????????  
gx=xd(:,1:k);d=xd(:,(k+1):(k+40));
P=gx';
T=d';

%??BP????
[R,~]=size(P);
[S2,Q]=size(T);
net=newff(minmax(P),T,[fix(sqrt(R*S2))],{'purelin','purelin'},'traingdx');

%??BP????
net.trainparam.epochs=10000;    %????
net.trainparam.goal=0.00001;    %??????
net.divideFcn = '';            %??????????
[net,~]=train(net,P,T);       %P????T????????

%??BP????
Y=sim(net,P);

%% ??????BP???????????
display('test bpnn begining...');
%??BP????
s=0;
    load('Mat/PCA.mat');
    load('Mat/scaling.mat');
    load('Mat/trainData.mat');
%     load('Mat/multiSVMTrain.mat');
    display('..............................');
for i=1:40
    for j=6:10                              %??40x5?????
         a=imread(strcat('Data/test/s',num2str(i),'/',num2str(j),'.pgm'));
         b=a(1:10304);
         b=double(b);
         TestFace=b;
         [m , ~] = size(TestFace);
         TestFace = (TestFace-repmat(meanVec, m, 1))*V; % ??pca????
         TestFace = scaling(TestFace,1,A0,B0);
         X = TestFace;
         Z=sim(net,X');
         [~,index2]=max(Z);
         if index2==i   
             s=s+1;
         else
%              i                             %?????????? i
%              j                           %??????????? j
%              index2;                         %??????????
            % disp=(['????? ' ,num2str(i), '????', num2str(j) , '?????????' ,num2str(index2), '?']);
         end
     end
end

%?????
accuracy=s/Q;
disp(num2str(accuracy));
