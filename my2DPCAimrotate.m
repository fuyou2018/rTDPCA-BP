
clear 
display(' ');
display(' ');
display('train begining...');

nPerson=5;
nFacesPerPerson = 50;
nFaces=250;%?????????40*5=200????
n=1;  
display('PCA down...');
k=n*64;   %? k ?????????

ORLPath= ['/Users/fuyou/Desktop/ORL/s01';'/Users/fuyou/Desktop/ORL/s02';'/Users/fuyou/Desktop/ORL/s03';'/Users/fuyou/Desktop/ORL/s04';'/Users/fuyou/Desktop/ORL/s05';];
BMPPath = ['_01.jpg';'_02.jpg';'_03.jpg';'_04.jpg';'_05.jpg';'_06.jpg';'_07.jpg';'_08.jpg';'_09.jpg';'_00.jpg';'_11.jpg';'_12.jpg';'_13.jpg';'_14.jpg';'_15.jpg';'_16.jpg';'_17.jpg';'_18.jpg';'_19.jpg';'_20.jpg';'_21.jpg';'_22.jpg';'_23.jpg';'_24.jpg';'_25.jpg';'_26.jpg';'_27.jpg';'_28.jpg';'_29.jpg';'_30.jpg';'_31.jpg';'_32.jpg';'_33.jpg';'_34.jpg';'_35.jpg';'_36.jpg';'_37.jpg';'_38.jpg';'_39.jpg';'_40.jpg';'_41.jpg';'_42.jpg';'_43.jpg';'_44.jpg';'_45.jpg';'_46.jpg';'_47.jpg';'_48.jpg';'_49.jpg';'_50.jpg';];
% ??????A(:,:,i)  
s=5;
s5=50*s;
for i = 1: s
    for j = 1:50 
        w =[ORLPath(i,:), BMPPath(j,:)]; 
        a1 =double(rgb2gray(imread(w)));              % ??????????????? 
        A (:,:,(i-1)*50 +j) = a1; 
    end 
end 

 for i=1:250
     A30(:,:,i)=imrotate(A(:,:,i),-30,'bilinear','crop');   %??????????
 end
  for i=1:250
     A60(:,:,i)=imrotate(A(:,:,i),-60,'bilinear','crop');
  end
 for i=1:250
     A90(:,:,i)=imrotate(A(:,:,i),-90,'bilinear','crop');
 end
  for i=1:250
     A120(:,:,i)=imrotate(A(:,:,i),-120,'bilinear','crop');
  end
  for i=1:250
     A150(:,:,i)=imrotate(A(:,:,i),-150,'bilinear','crop');
  end
 
% ????? ef ????????  
ef=zeros(64,64); 
for i=1: s5
    ef=ef+A(:,:,i); 
end 
ef=ef/s5;                 %???ef
Gt=zeros(64,64);
for i=1:s5
     Gt= Gt+(A(:,:,i)-ef)'*(A(:,:,i)-ef);    % ????Gt 
   end
Gt=Gt/s5 ;
[V,D]=eig(Gt);       % ??Gt????V???????D 
d=diag(D);          % ??D??????d
[d2,index]=dsort(d);       % ?????????d??????????d1????index????d1?????d????
                         % ????n???????
for i=1:n
       X(:,i)=V(:,index(i));   % n????????????????????? X??92?n?
   end
 for i=1:s5     
        Y(:,:,i)=(A(:,:,i)-ef)*X;       %  ????????? ?????X ???????????Y??112?92?*?92?n?=?112?n?
 end
 
 
 
 
 % ????? ef ????????  
ef30=zeros(64,64); 
for i=1: s5
    ef30=ef30+A30(:,:,i); 
end 
ef30=ef30/s5;                 %???ef
Gt30=zeros(64,64);
for i=1:s5
     Gt30= Gt30+(A30(:,:,i)-ef30)'*(A30(:,:,i)-ef30);    % ????Gt 
   end
Gt30=Gt30/s5 ;
[V30,D30]=eig(Gt);       % ??Gt????V???????D 
d30=diag(D30);          % ??D??????d
[~,index30]=dsort(d30);       % ?????????d??????????d1????index????d1?????d????
                         % ????n???????
for i=1:n
       X30(:,i)=V30(:,index30(i));   % n????????????????????? X??92?n?
   end
 for i=1:s5     
        Y30(:,:,i)=(A30(:,:,i)-ef30)*X30;       %  ????????? ?????X ???????????Y??112?92?*?92?n?=?112?n?
 end
 
 
 
 
 
    BMPPath = ['_51.jpg';'_52.jpg';'_53.jpg';'_54.jpg';'_55.jpg';'_56.jpg';'_57.jpg';'_58.jpg';'_59.jpg';'_60.jpg';'_61.jpg';'_62.jpg';'_63.jpg';'_64.jpg';'_65.jpg';'_66.jpg';'_67.jpg';'_68.jpg';'_69.jpg';'_70.jpg';'_71.jpg';'_72.jpg';'_73.jpg';'_74.jpg';'_75.jpg';'_76.jpg';'_77.jpg';'_78.jpg';'_79.jpg';'_80.jpg';'_81.jpg';'_82.jpg';'_83.jpg';'_84.jpg';'_85.jpg';'_86.jpg';'_87.jpg';'_88.jpg';'_89.jpg';'_90.jpg';'_91.jpg';'_92.jpg';'_93.jpg';'_94.jpg';'_95.jpg';'_96.jpg';'_97.jpg';'_98.jpg';'_99.jpg';'_00.jpg';];  % ????
for i = 1:s  
   for j = 1:50
       w = [ORLPath(i,:), BMPPath(j,:)]; 
       b1 = double(rgb2gray(imread(w))); 
       B(:,:,50*(i-1)+j)=b1;             % ????B?200?????????S01_6,S01_7,S01_8,S01_9,S01_0,  S02_6,S02_7,S02_8,S02_9,S02_0,.........
   end 
end
ef1=zeros(64,64); 
for i=1: s5
    ef1=ef1+B(:,:,i); 
end 
ef1=ef1/s5; 
for i=1:s5
    YT(:,:,i)=(B(:,:,i)-ef1)*X;     %   ?????B????????????? ?????? ?????YT
    YT1(:,i)=reshape(YT(:,:,i),1,[]);
end

trainLabel=zeros(250,1);
for ac=1:250
      trainLabel(ac)=ceil(ac/50);                % ?????????  11111111....111  222.....22  333.....33   4444.....44 ......
end

pcaFaces = YT1';


X2 = pcaFaces;
display('normalization begining...');
display('.........');

[X2,A0,B0] = myscaling(X2);
%save('Mat/myscaling.mat', 'A0', 'B0');
% ?? scaling ??????? trainData.mat
TrainData = X2;
%save('Mat/trainData.mat', 'TrainData', 'trainLabel');
display('normalization finish...');

%% ?????????BP????

%????BP??????? P 
%200*49???, ???????????(?40????5?)????49???????
%?faceLabel?200*1???????
P=TrainData;
%???????? T
T=zeros(250,5);
 for i=1:5
    for j=1:50
      T((i-1)*50+j,i)=1;
    end
 end
 
%????????
%P(250*k)   T(250*5)????
gx2(:,1:k)=P;  %? k ????????? 
gx2(:,(k+1):(k+5))=T;
xd=gx2(randperm(numel(gx2)/(k+5)),:);   %matlab  randperm???????????????????  
gx=xd(:,1:k);d1=xd(:,(k+1):(k+5));
P=gx';
T=d1';

%??BP????
[R,~]=size(P);
[S2,Q]=size(T);
net=newff(minmax(P),T,[fix(sqrt(R*S2))],{'purelin','purelin'},'traingdx');   %minmax(A)????A????????????????

%??BP????
net.trainparam.epochs=50;    %????
net.trainparam.goal=0.00001;    %??????
net.divideFcn = '';            %??????????
[net,~]=train(net,P,T);       %P????T????????

%??BP????
Y=sim(net,P);

%% ??????BP???????????
display('test bpnn begining...');
%??BP????
s=0;err=0;
    %load('Mat/myscaling.mat');
%     load('Mat/multiSVMTrain.mat');
    display('..............................');
for i=1:5
    for j=51:99                              %??5*49=245????? /Users/fuyou/Desktop/ORL/s01_51.jpg
         a=rgb2gray(imread(strcat('/Users/fuyou/Desktop/ORL/s0',num2str(i),'_',num2str(j),'.jpg')));
         b=double(a);
         TestFace1=(b-ef1)*X; 
         TestFace = reshape(TestFace1,1,k);
         
         %TestFace = myscaling(TestFace,1,A0,B0);
         X1 = TestFace;
         Z=sim(net,X1');
         [~,index2]=max(Z);
         if index2==i   
             s=s+1;
         else
             err=err+1;
%              i                             %?????????? i
%              j                           %??????????? j
%              index2;                         %??????????
            % disp=(['????? ' ,num2str(i), '????', num2str(j) , '?????????' ,num2str(index2), '?']);
         end
     end
end

%?????
disp(num2str(err));
recognize=['recognition rate:',num2str((1-err/245)*100),'%'];
